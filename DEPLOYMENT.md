# YouAreCoder.com - Production Deployment Guide

**Server:** 37.27.21.167
**Date:** 2025-10-27

---

## ✅ Pre-Deployment Checklist

- [x] DNS A record configured: `*.youarecoder.com → 37.27.21.167`
- [ ] Traefik v2.10 installed
- [ ] Flask application deployed
- [ ] PostgreSQL database setup
- [ ] SSL certificates issued

---

## 1. Traefik Installation

### Step 1.1: Download and Install Traefik

SSH to server:
```bash
ssh root@37.27.21.167
```

Download and install Traefik:
```bash
cd /tmp
curl -L https://github.com/traefik/traefik/releases/download/v2.10.7/traefik_v2.10.7_linux_amd64.tar.gz -o traefik.tar.gz
tar -xzf traefik.tar.gz
mv traefik /usr/local/bin/
chmod +x /usr/local/bin/traefik
traefik version
```

Expected output:
```
Version:      2.10.7
Codename:     saintmarcelin
Go version:   go1.20.8
...
```

### Step 1.2: Create Directory Structure

```bash
mkdir -p /etc/traefik/config
mkdir -p /var/log/traefik
chmod 755 /etc/traefik
chmod 755 /etc/traefik/config
chmod 755 /var/log/traefik
```

### Step 1.3: Create acme.json for Let's Encrypt

```bash
touch /etc/traefik/acme.json
chmod 600 /etc/traefik/acme.json
```

### Step 1.4: Create Traefik Static Configuration

Create `/etc/traefik/traefik.yml`:

```bash
cat > /etc/traefik/traefik.yml << 'EOF'
# Traefik v2.10 Static Configuration
# YouAreCoder.com SaaS Platform

# API and Dashboard
api:
  dashboard: true
  insecure: false

# Entry Points
entryPoints:
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true

  websecure:
    address: ":443"
    http:
      tls:
        certResolver: letsencrypt

# Certificate Resolvers
certificatesResolvers:
  letsencrypt:
    acme:
      email: admin@youarecoder.com
      storage: /etc/traefik/acme.json
      httpChallenge:
        entryPoint: web

# Providers
providers:
  file:
    directory: /etc/traefik/config
    watch: true

# Logging
log:
  level: INFO
  filePath: /var/log/traefik/traefik.log

# Access Logs
accessLog:
  filePath: /var/log/traefik/access.log
  bufferingSize: 100
EOF
```

### Step 1.5: Create Flask App Dynamic Configuration

Create `/etc/traefik/config/flask-app.yml`:

```bash
cat > /etc/traefik/config/flask-app.yml << 'EOF'
# Dynamic Configuration for Main Flask Application
# Routes for *.youarecoder.com (company management)

http:
  routers:
    # Main Flask app router
    flask-app:
      rule: "HostRegexp(`{subdomain:[a-z0-9-]+}.youarecoder.com`)"
      entryPoints:
        - websecure
      service: flask-app
      middlewares:
        - secureHeaders
      tls:
        certResolver: letsencrypt
        domains:
          - main: "youarecoder.com"
            sans:
              - "*.youarecoder.com"

    # Root domain router
    flask-app-root:
      rule: "Host(`youarecoder.com`)"
      entryPoints:
        - websecure
      service: flask-app
      middlewares:
        - secureHeaders
      tls:
        certResolver: letsencrypt

  services:
    # Flask application service
    flask-app:
      loadBalancer:
        servers:
          - url: "http://127.0.0.1:5000"

  middlewares:
    # Security headers
    secureHeaders:
      headers:
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"
EOF
```

### Step 1.6: Create Workspaces Configuration Template

Create `/etc/traefik/config/workspaces.yml`:

```bash
cat > /etc/traefik/config/workspaces.yml << 'EOF'
# Dynamic Configuration for Workspace Routing
# This file will be auto-generated by Flask app when workspaces are created

http:
  routers: {}
  services: {}
  middlewares:
    # Security headers
    secureHeaders:
      headers:
        sslRedirect: true
        browserXssFilter: true
        contentTypeNosniff: true
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000
        customFrameOptionsValue: "SAMEORIGIN"

    # Rate limiting for workspace access
    rateLimitWorkspace:
      rateLimit:
        average: 100
        burst: 50
        period: 1m
EOF
```

### Step 1.7: Create Systemd Service

Create `/etc/systemd/system/traefik.service`:

```bash
cat > /etc/systemd/system/traefik.service << 'EOF'
[Unit]
Description=Traefik v2.10 Reverse Proxy
Documentation=https://doc.traefik.io/traefik/
After=network-online.target
Wants=network-online.target

[Service]
Type=notify
User=root
Group=root
ExecStart=/usr/local/bin/traefik --configFile=/etc/traefik/traefik.yml
Restart=on-failure
RestartSec=5s

# Security settings
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/etc/traefik /var/log/traefik
CapabilityBoundingSet=CAP_NET_BIND_SERVICE

[Install]
WantedBy=multi-user.target
EOF
```

### Step 1.8: Start Traefik

```bash
systemctl daemon-reload
systemctl enable traefik.service
systemctl start traefik.service
systemctl status traefik.service
```

### Step 1.9: Verify Traefik

```bash
# Check if Traefik is running
systemctl status traefik.service

# View logs
journalctl -u traefik.service -n 50 --no-pager

# Test HTTP redirect
curl -I http://youarecoder.com

# Should see: HTTP/1.1 308 Permanent Redirect
# Location: https://youarecoder.com/
```

---

## 2. Flask Application Deployment

### Step 2.1: Install Dependencies

```bash
# Install Python 3.11 (if not already)
apt update
apt install -y python3.11 python3.11-venv python3-pip

# Install PostgreSQL client
apt install -y postgresql-client

# Install system dependencies
apt install -y build-essential libpq-dev
```

### Step 2.2: Clone Repository

```bash
cd /root
# Since we don't have git repo yet, we'll transfer files manually
mkdir -p /root/youarecoder
```

### Step 2.3: Transfer Application Files

From your local machine, copy the application:

```bash
# On local machine
cd /home/mustafa/youarecoder
tar -czf youarecoder-app.tar.gz \
    app/ \
    migrations/ \
    config.py \
    requirements.txt \
    .gitignore

# Transfer to server (you'll need to do this manually or via scp)
# scp youarecoder-app.tar.gz root@37.27.21.167:/root/
```

On server:
```bash
cd /root
tar -xzf youarecoder-app.tar.gz -C youarecoder/
cd youarecoder
```

### Step 2.4: Create Virtual Environment

```bash
cd /root/youarecoder
python3.11 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt
```

### Step 2.5: Configure Environment

Create `.env` file:

```bash
cat > /root/youarecoder/.env << 'EOF'
FLASK_APP=app
FLASK_ENV=production
SECRET_KEY=your-very-secret-key-change-this-in-production
DATABASE_URL=postgresql://youarecoder_user:YouAreCoderDB2025@localhost:5432/youarecoder

# Workspace Configuration
WORKSPACE_PORT_RANGE_START=8001
WORKSPACE_PORT_RANGE_END=8100
WORKSPACE_BASE_DIR=/workspaces
EOF
```

### Step 2.6: Database Migration

```bash
cd /root/youarecoder
source venv/bin/activate

# Run migrations
flask db upgrade
```

### Step 2.7: Create Systemd Service for Flask

Create `/etc/systemd/system/youarecoder.service`:

```bash
cat > /etc/systemd/system/youarecoder.service << 'EOF'
[Unit]
Description=YouAreCoder Flask Application
After=network.target postgresql.service

[Service]
Type=simple
User=root
WorkingDirectory=/root/youarecoder
Environment="PATH=/root/youarecoder/venv/bin"
ExecStart=/root/youarecoder/venv/bin/gunicorn \
    --bind 127.0.0.1:5000 \
    --workers 4 \
    --timeout 120 \
    --access-logfile /var/log/youarecoder/access.log \
    --error-logfile /var/log/youarecoder/error.log \
    "app:create_app()"

Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
```

### Step 2.8: Install Gunicorn

```bash
source venv/bin/activate
pip install gunicorn
```

### Step 2.9: Create Log Directory

```bash
mkdir -p /var/log/youarecoder
chmod 755 /var/log/youarecoder
```

### Step 2.10: Start Flask Application

```bash
systemctl daemon-reload
systemctl enable youarecoder.service
systemctl start youarecoder.service
systemctl status youarecoder.service
```

---

## 3. Verification & Testing

### Step 3.1: Check Services

```bash
# Check Traefik
systemctl status traefik.service

# Check Flask
systemctl status youarecoder.service

# Check logs
journalctl -u traefik.service -n 20 --no-pager
journalctl -u youarecoder.service -n 20 --no-pager
```

### Step 3.2: Test SSL Certificate

```bash
# Wait 1-2 minutes for Let's Encrypt to issue certificate
sleep 120

# Check acme.json
ls -l /etc/traefik/acme.json

# Should have content (not 0 bytes)
cat /etc/traefik/acme.json | jq '.' || cat /etc/traefik/acme.json
```

### Step 3.3: Test Application Access

```bash
# Test HTTPS access
curl -I https://youarecoder.com

# Should return: HTTP/2 200
```

### Step 3.4: Test in Browser

Open in browser:
- https://youarecoder.com (should show login page)
- https://youarecoder.com/auth/register (should show registration)

---

## 4. Troubleshooting

### Traefik Not Starting

```bash
# Check configuration syntax
traefik --configFile=/etc/traefik/traefik.yml --validate

# Check logs
journalctl -u traefik.service -n 100 --no-pager
```

### SSL Certificate Not Issued

```bash
# Check Let's Encrypt logs
grep -i "acme" /var/log/traefik/traefik.log

# Verify DNS
dig youarecoder.com +short
# Should return: 37.27.21.167

# Verify port 80 is accessible
curl -I http://youarecoder.com
# Should redirect to HTTPS
```

### Flask Not Responding

```bash
# Check if Flask is running
systemctl status youarecoder.service

# Test local connection
curl http://127.0.0.1:5000

# Check logs
journalctl -u youarecoder.service -f
```

### Cannot Access via HTTPS

```bash
# Verify Traefik is listening on 443
netstat -tulpn | grep :443

# Check Traefik routes
cat /etc/traefik/config/flask-app.yml

# Reload Traefik (it should auto-reload, but just in case)
systemctl restart traefik.service
```

---

## 5. Post-Deployment

### Create First Company & User

```bash
# Via Flask shell
cd /root/youarecoder
source venv/bin/activate
flask shell
```

In Flask shell:
```python
from app import db
from app.models import Company, User

# Create company
company = Company(
    name="Test Company",
    subdomain="testco",
    admin_email="admin@testco.com",
    plan="starter",
    max_workspaces=5
)
db.session.add(company)
db.session.commit()

# Create user
user = User(
    username="admin",
    email="admin@testco.com",
    company_id=company.id,
    role="admin"
)
user.set_password("SecurePassword123!")
db.session.add(user)
db.session.commit()

print(f"Company created: {company.name}")
print(f"User created: {user.email}")
exit()
```

### Test Login

Go to https://testco.youarecoder.com/auth/login
- Email: admin@testco.com
- Password: SecurePassword123!

---

## 6. Monitoring

### View Logs

```bash
# Traefik logs
tail -f /var/log/traefik/traefik.log

# Traefik access logs
tail -f /var/log/traefik/access.log

# Flask logs
journalctl -u youarecoder.service -f

# All services
journalctl -u traefik.service -u youarecoder.service -f
```

### Check Certificate Renewal

```bash
# Check acme.json for expiration dates
cat /etc/traefik/acme.json | jq '.letsencrypt.Certificates[0].certificate' | base64 -d | openssl x509 -text -noout | grep "Not After"
```

---

## 🎉 Deployment Complete!

Your YouAreCoder platform should now be accessible at:
- **Main Site:** https://youarecoder.com
- **Company Sites:** https://[subdomain].youarecoder.com

**Next Steps:**
- Create company accounts via registration
- Create workspaces
- Test code-server provisioning
- Monitor logs for errors

---

**Support:**
- Traefik Docs: https://doc.traefik.io/traefik/
- Flask Docs: https://flask.palletsprojects.com/
- PostgreSQL: https://www.postgresql.org/docs/
